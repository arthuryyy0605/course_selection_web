# Nginx 配置手動更新指南

如果自動更新腳本無法執行，請手動更新 nginx 配置。

## 步驟

1. SSH 連接到遠端伺服器：
   ```bash
   ssh hostadm@140.120.3.145
   ```

2. 備份現有配置：
   ```bash
   sudo cp /etc/nginx/sites-available/course_selection_api /etc/nginx/sites-available/course_selection_api.backup
   ```

3. 編輯配置文件：
   ```bash
   sudo nano /etc/nginx/sites-available/course_selection_api
   ```

4. 將根路徑配置從：
   ```nginx
   location / {
       return 404;
   }
   ```
   
   改為：
   ```nginx
   # 根目錄：服務前端靜態文件
   root /home/hostadm/frontend_web/dist;
   index index.html;

   # 前端靜態文件服務
   location / {
       try_files $uri $uri/ /index.html;
       
       # 靜態資源緩存設置
       location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
           expires 1y;
           add_header Cache-Control "public, immutable";
       }
   }
   ```

5. 確保 `/api/` 配置在根路徑配置之前（已在現有配置中）

6. 測試配置：
   ```bash
   sudo nginx -t
   ```

7. 如果測試通過，重新載入 nginx：
   ```bash
   sudo systemctl reload nginx
   ```

## 完整配置範例

完整的 HTTPS server 區塊應該如下：

```nginx
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name _;

    # SSL 證書配置
    ssl_certificate /etc/letsencrypt/live/140.120.3.145/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/140.120.3.145/privkey.pem;

    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 日誌配置
    access_log /var/log/nginx/course_selection_api_access.log;
    error_log /var/log/nginx/course_selection_api_error.log;

    # 客戶端請求體大小限制
    client_max_body_size 10M;

    # 根目錄：服務前端靜態文件
    root /home/hostadm/frontend_web/dist;
    index index.html;

    # API 路徑反向代理到 FastAPI（必須在根路徑之前）
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        
        # 保留原始主機和協議信息
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket 支持（如果需要）
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 超時設置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 緩衝區設置
        proxy_buffering off;
    }

    # 前端靜態文件服務
    location / {
        try_files $uri $uri/ /index.html;
        
        # 靜態資源緩存設置
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # 健康檢查端點
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

## 注意事項

1. 前端文件路徑為 `/home/hostadm/frontend_web/dist`
2. 確保 `/api/` 配置在根路徑 `/` 之前，這樣 API 請求才會正確代理
3. `try_files` 指令對於 Vue Router 的 history 模式是必需的
4. 靜態資源緩存設置可以提升性能，但開發時可能需要清除緩存

